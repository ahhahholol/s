<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volixyshop</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background-color: #111; color: #ddd; min-height: 100vh; position: relative; }
        header { background-color: #222; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .shop-name { font-size: 2.5em; font-weight: bold; color: #fff; }
        .auth-buttons { display: flex; gap: 15px; }
        .bubble-btn { background-color: #333; color: #fff; border: none; padding: 12px 24px; font-size: 1em; border-radius: 50px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .bubble-btn:hover { background-color: #555; transform: translateY(-3px); }
        #user-display { font-size: 1.2em; color: #fff; display: none; align-items: center; gap: 10px; position: relative; }
        #hamburger { cursor: pointer; font-size: 1.5em; }
        #dropdown { display: none; position: absolute; top: 40px; right: 0; background: #333; padding: 10px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; min-width: 150px; }
        #dropdown div { padding: 10px; cursor: pointer; white-space: nowrap; }
        #dropdown div:hover { background: #444; }
        #add-product-btn { display: none; position: fixed; bottom: 30px; right: 30px; background-color: #555; color: #fff; border: none; width: 60px; height: 60px; font-size: 2em; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s; }
        #add-product-btn:hover { background-color: #777; transform: translateY(-3px); }
        .modal, #messages-list, #chat-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        .modal-content, #messages-content, #chat-content { background: #222; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; max-height: 80vh; overflow-y: auto; }
        input, select, #chat-input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 10px; border: none; background: #333; color: #fff; box-sizing: border-box; }
        button { background: #555; color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; margin: 5px; }
        .close { float: right; font-size: 1.8em; cursor: pointer; margin-top: -10px; }
        main { padding: 50px 20px; text-align: center; }
        #products-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .product-card { background: #222; padding: 15px; border-radius: 15px; width: 250px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .product-card img { max-width: 100%; height: 200px; object-fit: cover; border-radius: 10px; }
        .payment-icons { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; justify-content: center; }
        .payment-icon { font-size: 1.8em; }
        .chat-contact { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; text-align: left; }
        .chat-contact:hover { background: #333; }
        .member-since { font-size: 0.9em; color: #aaa; margin-top: 5px; }
        #chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .message { padding: 10px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .message.sent { background: #555; align-self: flex-end; }
        .message.received { background: #333; align-self: flex-start; }
        #chat-content { display: flex; flex-direction: column; height: 500px; }
    </style>
</head>
<body>
    <header>
        <div class="shop-name">Volixyshop</div>
        <div id="auth-section">
            <div class="auth-buttons">
                <button class="bubble-btn" id="signup-btn">Sign Up</button>
                <button class="bubble-btn" id="login-btn">Login</button>
            </div>
        </div>
        <div id="user-display">
            <span id="user-name"></span>
            <span id="hamburger">â˜°</span>
            <div id="dropdown">
                <div id="user-name-dropdown"></div>
                <div id="messages-link">Messages</div>
                <div id="logout-link">Logout</div>
            </div>
        </div>
    </header>

    <main>
        <h1>Welcome to Volixyshop</h1>
        <div id="products-container"></div>
    </main>

    <button id="add-product-btn">+</button>

    <!-- Modals -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Sign Up</h2>
            <input type="text" id="signupName" placeholder="Name">
            <input type="email" id="signupEmail" placeholder="Email">
            <input type="password" id="signupPass" placeholder="Password">
            <button id="do-signup">Sign Up</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPass" placeholder="Password">
            <button id="do-login">Login</button>
        </div>
    </div>

    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <h2>Enter Verification Code</h2>
            <p>A code has been sent to your email.</p>
            <input type="text" id="verifyCode" placeholder="6-digit code">
            <button id="do-verify">Verify</button>
        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Product</h2>
            <input type="number" step="0.01" id="productPrice" placeholder="Price (e.g., 10.99)">
            <input type="text" id="productDesc" placeholder="Description">
            <input type="file" id="productImage" accept="image/*">
            <button id="do-add-product">Add Product</button>
        </div>
    </div>

    <div id="messages-list">
        <div id="messages-content">
            <span class="close">&times;</span>
            <h2>Messages</h2>
            <div id="contacts-list"></div>
        </div>
    </div>

    <div id="chat-modal">
        <div id="chat-content">
            <span class="close">&times;</span>
            <h2 id="chat-title">Chat</h2>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Type message...">
            <button id="send-message">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-5jb0cX0HKAfT3NFxoXe1joIIbl_Andg",
            authDomain: "volixyshop907.firebaseapp.com",
            databaseURL: "https://volixyshop907-default-rtdb.firebaseio.com",
            projectId: "volixyshop907",
            storageBucket: "volixyshop907.firebasestorage.app",
            messagingSenderId: "1020559272490",
            appId: "1:1020559272490:web:1247fa96bcb9ed9cb4b153"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        (function() { emailjs.init("aoeLIpwJguZGOvXYP"); })();

        // Stripe
        const stripe = Stripe('pk_test_51SeTvH38whRIovwCuke6Jd4kdtbmvTfUG8ghXucUk1ijJsWBKuG0mXrOZj17BLSraQPlNFCNTv3R7QEgMXZlhxPe00Z1uAY2mq');

        let currentAction = '';
        let tempUser = {};
        let correctCode = '';
        let currentUser = null;
        let currentChatContact = null;
        let currentChatId = null;
        let messagesUnlisten = null;

        const openModal = (id) => document.getElementById(id).style.display = 'flex';
        const closeModal = (id) => document.getElementById(id).style.display = 'none';

        // Event Listeners
        document.getElementById('signup-btn').addEventListener('click', () => openModal('signupModal'));
        document.getElementById('login-btn').addEventListener('click', () => openModal('loginModal'));
        document.getElementById('add-product-btn').addEventListener('click', () => openModal('addProductModal'));
        document.getElementById('hamburger').addEventListener('click', () => {
            const d = document.getElementById('dropdown');
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        });
        document.getElementById('messages-link').addEventListener('click', () => {
            loadContacts();
            document.getElementById('messages-list').style.display = 'flex';
        });
        document.getElementById('logout-link').addEventListener('click', () => signOut(auth).then(() => location.reload()));
        document.querySelectorAll('.close').forEach(el => el.addEventListener('click', (e) => e.target.closest('.modal, #messages-list, #chat-modal').style.display = 'none'));

        document.getElementById('do-signup').addEventListener('click', handleSignup);
        document.getElementById('do-login').addEventListener('click', handleLogin);
        document.getElementById('do-verify').addEventListener('click', handleVerify);
        document.getElementById('do-add-product').addEventListener('click', handleAddProduct);
        document.getElementById('send-message').addEventListener('click', sendMessage);

        function generateCode() { return Math.floor(100000 + Math.random() * 900000).toString(); }

        function sendVerificationEmail(email, name, code) {
            emailjs.send("Volixyshop907", "Volixyshop", { to_email: email, to_name: name || "User", code, from_name: "Volixyshop" })
                .then(() => alert("Verification code sent!"), err => alert("Email failed: " + JSON.stringify(err)));
        }

        function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const pass = document.getElementById('signupPass').value;
            if (!name || !email || !pass) return alert("Fill all fields");
            currentAction = 'signup';
            tempUser = { name, email, pass };
            correctCode = generateCode();
            sendVerificationEmail(email, name, correctCode);
            closeModal('signupModal');
            openModal('verifyModal');
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value;
            if (!email || !pass) return alert("Fill all fields");
            currentAction = 'login';
            tempUser = { email, pass };
            correctCode = generateCode();
            sendVerificationEmail(email, "User", correctCode);
            closeModal('loginModal');
            openModal('verifyModal');
        }

        function handleVerify() {
            const entered = document.getElementById('verifyCode').value.trim();
            if (entered !== correctCode) return alert("Wrong code");
            if (currentAction === 'signup') {
                createUserWithEmailAndPassword(auth, tempUser.email, tempUser.pass)
                    .then(cred => {
                        set(ref(db, 'users/' + cred.user.uid), { name: tempUser.name, email: tempUser.email, joinDate: Date.now() });
                        showLoggedIn(cred.user);
                    }).catch(e => alert(e.message));
            } else {
                signInWithEmailAndPassword(auth, tempUser.email, tempUser.pass)
                    .then(cred => showLoggedIn(cred.user)).catch(e => alert(e.message));
            }
            closeModal('verifyModal');
        }

        function showLoggedIn(user) {
            get(child(ref(db), `users/${user.uid}`)).then(snap => {
                currentUser = { uid: user.uid, ...snap.val() };
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('user-name').textContent = `Hello, ${currentUser.name}!`;
                document.getElementById('user-name-dropdown').textContent = currentUser.name;
                document.getElementById('user-display').style.display = 'flex';
                document.getElementById('add-product-btn').style.display = 'block';
                loadProducts();
            });
        }

        function handleAddProduct() {
            if (!currentUser) return alert("Login required");
            const price = parseFloat(document.getElementById('productPrice').value);
            const desc = document.getElementById('productDesc').value.trim();
            const file = document.getElementById('productImage').files[0];
            if (!price || !desc || !file) return alert("Fill all fields");

            const reader = new FileReader();
            reader.onload = e => {
                const newRef = push(ref(db, 'products'));
                set(newRef, {
                    sellerUid: currentUser.uid,
                    sellerName: currentUser.name,
                    price,
                    desc,
                    image: e.target.result
                });
                loadProducts();
                closeModal('addProductModal');
            };
            reader.readAsDataURL(file);
        }

        function loadProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            onValue(ref(db, 'products'), snap => {
                container.innerHTML = '';
                const products = snap.val() || {};
                Object.entries(products).forEach(([id, prod]) => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <img src="${prod.image}" alt="${prod.desc}">
                        <h3>${prod.desc}</h3>
                        <p>$${prod.price.toFixed(2)}</p>
                        <p>Seller: ${prod.sellerName}</p>
                        <button class="buy-btn bubble-btn">Buy Now</button>
                    `;
                    card.querySelector('.buy-btn').addEventListener('click', () => handleBuy(id));
                    container.appendChild(card);
                });
            });
        }

        async function handleBuy(productId) {
            if (!currentUser) return openModal('loginModal');

            const snap = await get(child(ref(db), `products/${productId}`));
            if (!snap.exists()) return alert("Product not found");
            const prod = snap.val();

            // Create Stripe Checkout Session (test mode - secret key exposed only for demo)
            const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer sk_test_51SeTvH38whRIovwC6CsajQ7AIHanVTBqfulSQZDkbmEPkQoor8eSqyhuwMmA3u10PBD7O0PLYVbE5FfkZwYJxYXd00y8OjMDKa',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'payment_method_types[]': 'card',
                    'line_items[0][price_data][currency]': 'usd',
                    'line_items[0][price_data][unit_amount]': Math.round(prod.price * 100),
                    'line_items[0][price_data][product_data][name]': prod.desc,
                    'line_items[0][quantity]': 1,
                    'mode': 'payment',
                    'success_url': window.location.origin + '?payment=success',
                    'cancel_url': window.location.origin + '?payment=cancel',
                    'metadata[productId]': productId,
                    'metadata[buyerUid]': currentUser.uid,
                    'metadata[sellerUid]': prod.sellerUid
                })
            });

            const session = await response.json();
            if (session.id) {
                // Start chat first
                openChat(prod.sellerUid, prod.sellerName);
                // Redirect to Stripe
                stripe.redirectToCheckout({ sessionId: session.id });
            } else {
                alert("Payment error: " + session.error.message);
            }
        }

        function openChat(uid, name) {
            currentChatContact = uid;
            currentChatId = [currentUser.uid, uid].sort().join('-');
            get(child(ref(db), `users/${uid}`)).then(s => {
                const join = s.val()?.joinDate ? new Date(s.val().joinDate).toLocaleDateString() : '';
                document.getElementById('chat-title').textContent = `Chat with ${name}${join ? ' (since ' + join + ')' : ''}`;
            });
            loadChatMessages();
            document.getElementById('chat-modal').style.display = 'flex';
            document.getElementById('messages-list').style.display = 'none';
        }

        function loadChatMessages() {
            const div = document.getElementById('chat-messages');
            if (messagesUnlisten) messagesUnlisten();
            messagesUnlisten = onValue(ref(db, `chats/${currentChatId}/messages`), snap => {
                div.innerHTML = '';
                const msgs = snap.val() || {};
                Object.values(msgs).sort((a,b) => a.time - b.time).forEach(m => {
                    const el = document.createElement('div');
                    el.className = `message ${m.from === currentUser.uid ? 'sent' : 'received'}`;
                    el.textContent = m.text;
                    div.appendChild(el);
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            push(ref(db, `chats/${currentChatId}/messages`), { from: currentUser.uid, text, time: Date.now() });
            input.value = '';
        }

        function loadContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '<p>Loading...</p>';
            onValue(ref(db, 'chats'), snap => {
                list.innerHTML = '';
                const chats = snap.val() || {};
                const added = new Set();
                Object.keys(chats).forEach(chatId => {
                    const chat = chats[chatId];
                    const other = chat.participants?.find(u => u !== currentUser.uid);
                    if (other && !added.has(other)) {
                        get(child(ref(db), `users/${other}`)).then(u => {
                            if (u.exists()) {
                                const data = u.val();
                                const div = document.createElement('div');
                                div.className = 'chat-contact';
                                const join = data.joinDate ? new Date(data.joinDate).toLocaleDateString() : '';
                                div.innerHTML = `${data.name}<div class="member-since">Member since ${join}</div>`;
                                div.onclick = () => openChat(other, data.name);
                                list.appendChild(div);
                            }
                        });
                        added.add(other);
                    }
                });
                if (!list.children.length) list.innerHTML = '<p>No messages yet.</p>';
            });
        }

        // Handle return from Stripe
        const params = new URLSearchParams(window.location.search);
        if (params.get('payment') === 'success') {
            alert('Payment successful! Thank you. Message the seller for confirmation.');
            history.replaceState({}, '', window.location.pathname);
        } else if (params.get('payment') === 'cancel') {
            alert('Payment cancelled.');
            history.replaceState({}, '', window.location.pathname);
        }

        onAuthStateChanged(auth, user => {
            if (user) showLoggedIn(user);
            else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('user-display').style.display = 'none';
                document.getElementById('add-product-btn').style.display = 'none';
                loadProducts();
            }
        });

        loadProducts();
    </script>
</body>
</html>
